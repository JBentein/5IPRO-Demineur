<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Démineur</title>
    <style>
        #table {
            border: 1px solid black;
            border-collapse: collapse;
        }

        td {
            width: 20px;
            height: 20px;
            background-color: grey;
            border: 1px solid black;
        }
        #table >   {
            background-color: green;
        }
    </style>
</head>

<body>
    <h1>Jeu du démineur</h1>
    <p>Nombre de mines : <span id="nbreMines"></span></p>
    <p>Nombre de lignes : <span id="nbreLignes"></span></p>
    <p>Nombre de colonnes : <span id="nbreCol"></span></p>

    <button onclick="facile()">Facile</button>
    <button onclick="moyen()">Moyen</button>
    <button onclick="difficile()">Difficile</button>

    <p>Choisi ? <span><button onclick="creation()">GO</button></span></p>
    <table id="table"></table>
</body>

<script>
    //------------------------------------------------------------
    //------------------------------------------------------------
    // Initialisation des données de construction :---------------

    const composants =
    {
        nbreLignes: 8,
        nbreCellules: 8,
        nbreBombes: 10
    };

    const plateau = [];

    //------------------------------------------------------------
    //------------------------------------------------------------
    // Choix de difficulté :--------------------------------------

    function facile()
    {
        
        composants.nbreBombes = 10;
        composants.nbreLignes = 8;
        composants.nbreCellules = 8;
        displayData();
    }
    function moyen()
    {
        
        composants.nbreBombes = 15;
        composants.nbreLignes = 12;
        composants.nbreCellules = 12;
        displayData();
    }
    function difficile()
    {
    
        composants.nbreBombes = 20;
        composants.nbreLignes = 15;
        composants.nbreCellules = 15;
        displayData();
    }

    //------------------------------------------------------------
    //------------------------------------------------------------
    // Affichage des données :------------------------------------
    function resetTable(){
        let tb = document.querySelector("#table").innerHTML="";
    
    }
    function displayData()
    {
        document.querySelector("#nbreMines").innerText = composants.nbreBombes;
        document.querySelector("#nbreLignes").innerText = composants.nbreLignes;
        document.querySelector("#nbreCol").innerText = composants.nbreCellules;
    }

    //------------------------------------------------------------
    //------------------------------------------------------------
    // Création plateau :-----------------------------------------

    function creation()
    {
        for (let i = 0; i < composants.nbreLignes; i++)
        {
            plateau[i] = [];
            for (let j = 0; j < composants.nbreCellules; j++)
            {
                plateau[i][j] = 0;
            }
        }
        etalage();
        creationPlatHTML();
    }

    //------------------------------------------------------------
    //------------------------------------------------------------
    // Étalage des mines :----------------------------------------

    function etalage()
    {
        for (let i = 0; i < composants.nbreBombes; i++)
        {
            placement();
        }
        console.table(plateau);
        numeros();
    }

    //------------------------------------------------------------
    //------------------------------------------------------------
    // Fonction récursive de placement de mine individuelle :-----    

    function placement()
    {
        let ligne = Math.floor(Math.random() * composants.nbreLignes);
        let cellule = Math.floor(Math.random() * composants.nbreCellules);
        if (plateau[ligne][cellule] == "B")
        {
            placement();
        }
        else plateau[ligne][cellule] = "B";
    }

    //------------------------------------------------------------
    //------------------------------------------------------------
    // Création homologue plateau HTML :--------------------------

    function creationPlatHTML()
    {
        let box = document.querySelector("#table");
        for (let i = 0; i < composants.nbreLignes; i++)
        {
            let ligne = document.createElement("tr");
            for (let j = 0; j < composants.nbreCellules; j++)
            {
                let cellule = document.createElement("td");
                cellule.setAttribute("data-ligne", i);
                cellule.setAttribute("data-cellule", j);
                cellule.setAttribute("data-statut", "cachee")
                cellule.setAttribute("data-flag", "faux")
                if(plateau[i][j]=="B"){
                    cellule.setAttribute("data-mine", "true");
                }
                else{
                    cellule.setAttribute("data-mine", "false");
                }
                // Ajout permet de cliquer : ↓
                cellule.addEventListener("click", cliquage);
                ligne.appendChild(cellule);
                //ajout marqueur de mine
            cellule.addEventListener("contextmenu",e => {e.preventDefault()
                marquerMine()
            }
            ) 
            }/*cellule.style.backGroundColor="green"*/
            box.appendChild(ligne);
        }
    }

    //------------------------------------------------------------
    //------------------------------------------------------------
    // Fonction répartition des numéros :-------------------------

    function numeros()
    {
        resetTable();
        for (let i = 0; i < composants.nbreLignes; i++)
        {
            for (let j = 0; j < composants.nbreCellules; j++)
            {
                if (plateau[i][j] == "B")
                {
                    let compteurI = 1;
                    for (let k = i - 1; compteurI <= 3; compteurI++)
                    {
                        if (k < 0)
                        {
                            k++;
                            continue;
                        }
                        if (k >= composants.nbreLignes)
                        {
                            compteurI = 4;
                            continue;
                        }
                        let compteurJ = 1;
                        for (let l = j - 1; compteurJ <= 3; compteurJ++)
                        {
                            if (l < 0)
                            {
                                l++;
                                continue;
                            }
                            if (l >= composants.nbreCellules)
                            {
                                compteurJ = 4;
                                continue;
                            }
                            if (plateau[k][l] == "B")
                            {
                                l++;
                                continue;
                            }
                            else
                            {
                                plateau[k][l]++;
                                l++;
                            }
                        }
                        k++;
                    }
                }
            }
        }
        console.table(plateau);
    }

    //------------------------------------------------------------
    //------------------------------------------------------------
    // Fonction lors du clic sur une cellule :--------------------

    function cliquage()
    {
        let nligne = parseInt(event.target.getAttribute('data-ligne'));
        let ncellule = parseInt(event.target.getAttribute('data-cellule'));
        let infoBoum="ouf";
        if(event.target.getAttribute("data-mine")=="true"){
            event.target.style.backgroundColor="red";
            infoBoum="BOOUUMMM";
        }
        else if (event.target.getAttribute("data-mine")=="false")
        {
        event.target.style.backgroundColor="beige"
        event.target.innerText=plateau[nligne][ncellule];
        }
        console.log(nligne, ncellule, infoBoum);
    }
    function marquerMine(){
        let estMarquee = event.target.getAttribute('data-flag');
        if(estMarquee=="faux"){
       event.target.style.backgroundColor="grey";
       event.target.setAttribute("data-flag", "vrai");
        }
        else if(estMarquee=="vrai") {
        event.target.style.backgroundColor="green";
        event.target.setAttribute("data-flag", "faux");
        }
    }

    //------------------------------------------------------------
    //condition défaite
    
</script>

</html>